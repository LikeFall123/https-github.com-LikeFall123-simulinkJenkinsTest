// Define path variable outside to ensure scope visibility
def pipelineGenerationPath = ""

node('simulink-test-jenkins-agent-label'){
    // --- FIX 1: GLOBAL CONFIGURATION ---
    def sharedConfigDir = "C:\\Data\\Jenkins_Global_Config"
    
    // --- FIX 2: FORCE MATAB VERSION ---
    // Prepend R2025a to the PATH. 
    // This guarantees the generated pipeline picks R2025a, not any other version on the PC.
    env.PATH = "C:\\Program Files\\MATLAB\\R2025a\\bin;${env.PATH}"
    
    // --- FIX 3: ENVIRONMENT VARIABLES ---
    env.MW_SUPPORT_PACKAGE_ROOT = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    env.MW_REMOTE_BUILD_CACHE_NAME = "$JOB_NAME"
    env.MW_PIPELINE_GEN_DIRECTORY = "_pipelineGen_"
    
    // Force startup.m loading for ALL instances
    env.MATLABPATH = sharedConfigDir 
    
    // Force Local Temp (fixes PID crashes)
    env.TEMP = "${WORKSPACE}\\.matlab_temp"
    env.TMP = "${WORKSPACE}\\.matlab_temp"

    // Standard Configuration
    def matlabExePath = "C:\\Program Files\\MATLAB\\R2025a\\bin\\matlab.exe"
    def matlabSupportPkgRoot = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    pipelineGenerationPath = "${env.MW_RELATIVE_PROJECT_PATH?:''}${env.MW_PIPELINE_GEN_DIRECTORY}"
    
    stage('Setup & Generation'){
        cleanWs(disableDeferredWipeout:true, deleteDirs:true)
        def scmVars = checkout scm
        
        // --- FIX 4: ROBUST STARTUP.M ---
        bat "if not exist \"${sharedConfigDir}\" mkdir \"${sharedConfigDir}\""
        
        // This script now handles Temp creation AND adding Support Packages
        // It will run for EVERY MATLAB instance (Gen path AND Generated Pipeline)
        writeFile file: "${sharedConfigDir}\\startup.m", text: """
            % 1. Fix Temp Directory (PID Issue)
            try
                tempRoot = getenv('TEMP');
                if ~isempty(tempRoot)
                    myPid = feature('getpid');
                    pidDir = fullfile(tempRoot, num2str(myPid));
                    if ~isfolder(pidDir)
                        mkdir(pidDir);
                        fprintf('### startup.m: Created PID temp dir: %s\\n', pidDir);
                    end
                end
            catch ME
                fprintf('### startup.m: Temp dir setup failed: %s\\n', ME.message);
            end
            
            % 2. Add Support Packages to Path
            try
                spRoot = getenv('MW_SUPPORT_PACKAGE_ROOT');
                if ~isempty(spRoot) && isfolder(spRoot)
                    addpath(genpath(spRoot));
                    fprintf('### startup.m: Added Support Package Root: %s\\n', spRoot);
                else
                    fprintf('### startup.m: MW_SUPPORT_PACKAGE_ROOT not set or invalid.\\n');
                end
            catch ME
                fprintf('### startup.m: Path setup failed: %s\\n', ME.message);
            end
        """
        
        // Create local temp for this stage
        bat "if not exist \"${env.TEMP}\" mkdir \"${env.TEMP}\""

        // Copy Utilities
        def command = "copy /Y \"${matlabSupportPkgRoot}\\toolbox\\padv\\pipeline_generator\\ci\\templates\\jenkins\\MW_PipelineUtils.groovy\" \"$WORKSPACE\""
        bat(command)
        
        // Generate Pipeline
        def pipelineUtils = load("$WORKSPACE/MW_PipelineUtils.groovy")
        
        // Note: We use the specific EXE here, but the PATH env var above 
        // ensures the generated pipeline also finds this exact version.
        def matlabCommand = """
            "${matlabExePath}" -batch "
            addpath('$WORKSPACE'); 
            generate_jenkins_pipeline();"
        """
        
        matlabCommand = matlabCommand.replaceAll("\n", "").replaceAll("  ", "")
        pipelineUtils.runShellCommand(matlabCommand, false)
        
        stash includes:"${pipelineGenerationPath}/**", name:'pipeline_generated_files'
        archiveArtifacts artifacts: "${pipelineGenerationPath}/**", allowEmptyArchive: true
        pipelineUtils.loadEnvVariables(false, scmVars.GIT_COMMIT)
    }
    load("${WORKSPACE}/${pipelineGenerationPath}/simulink_pipeline")
}