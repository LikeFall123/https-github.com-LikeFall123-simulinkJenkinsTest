// Define path variable outside to ensure scope visibility
def pipelineGenerationPath = ""

node('simulink-test-jenkins-agent-label'){

    env.MW_SUPPORT_PACKAGE_ROOT = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    env.MW_REMOTE_BUILD_CACHE_NAME = "$JOB_NAME"
    env.MW_PIPELINE_GEN_DIRECTORY = "_pipelineGen_"

    // FIX START
    env.MATLAB_PREFDIR = "${WORKSPACE}\\.matlab_prefs"
    env.TEMP = "${WORKSPACE}\\.matlab_temp"
    env.TMP = "${WORKSPACE}\\.matlab_temp"
    // FIX END

    def matlabExePath = "C:\\Program Files\\MATLAB\\R2025a\\bin\\matlab.exe"
    def matlabSupportPkgRoot = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    
    pipelineGenerationPath = "${env.MW_RELATIVE_PROJECT_PATH?:''}${env.MW_PIPELINE_GEN_DIRECTORY}"
    
    stage('Pipeline Generation'){
        cleanWs(disableDeferredWipeout:true, deleteDirs:true)
        def scmVars = checkout scm

        // --- FIX START: CREATE startup.m ---
        writeFile file: 'startup.m', text: """
            try
                % 1. Get the root temp dir (env var TEMP)
                tempRoot = getenv('TEMP');
                
                % 2. Get the current MATLAB Process ID (PID)
                myPid = feature('getpid');
                
                % 3. Construct the exact path Simulink will use
                pidDir = fullfile(tempRoot, num2str(myPid));

                % Get the temp directory MATLAB wants to use (includes PID)
                % td = tempdir;
                if ~isfolder(pidDir)
                    mkdir(pidDir);
                    fprintf('### startup.m: Created missing temp dir: %s\\n', pidDir);
                else
                    fprintf('### startup.m: Temp dir exists: %s\\n', pidDir);
                end
            catch ME
                fprintf('### startup.m: Failed to create temp dir. %s\\n', ME.message);
            end
        """
        // --- FIX END ---

        // FIX START
        bat "if not exist \"${env.MATLAB_PREFDIR}\" mkdir \"${env.MATLAB_PREFDIR}\""
        bat "if not exist \"${env.TEMP}\" mkdir \"${env.TEMP}\""
        // FIX END

        def command = "copy /Y \"${matlabSupportPkgRoot}\\toolbox\\padv\\pipeline_generator\\ci\\templates\\jenkins\\MW_PipelineUtils.groovy\" \"$WORKSPACE\""
        bat(command)
        
        def pipelineUtils = load("$WORKSPACE/MW_PipelineUtils.groovy")

        // Remove Simulink.fileGenControl -> Pipeline Success, but no CI run
        def matlabCommand = """
            "${matlabExePath}" -batch "
            addpath(genpath('${matlabSupportPkgRoot}')); 
            addpath('$WORKSPACE');
            generate_jenkins_pipeline();"
        """
        
        matlabCommand = matlabCommand.replaceAll("\n", "").replaceAll("  ", "")
        pipelineUtils.runShellCommand(matlabCommand, false)
        stash includes:"${pipelineGenerationPath}/**", name:'pipeline_generated_files'
        archiveArtifacts artifacts: "${pipelineGenerationPath}/**", allowEmptyArchive: true
        pipelineUtils.loadEnvVariables(false, scmVars.GIT_COMMIT)
    }

    load("${WORKSPACE}/${pipelineGenerationPath}/simulink_pipeline")
}

