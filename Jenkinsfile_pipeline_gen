// Define path variable outside to ensure scope visibility
def pipelineGenerationPath = ""

node('simulink-test-jenkins-agent-label'){
    
    // 1. DEFINE THE CRITICAL PATH
    // This is the location where the CI Pipeline toolbox lives.
    def matlabSupportPkgRoot = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    
    pipelineGenerationPath = "${env.MW_RELATIVE_PROJECT_PATH?:''}${env.MW_PIPELINE_GEN_DIRECTORY}"
    
    stage('Pipeline Generation'){
        cleanWs(disableDeferredWipeout:true, deleteDirs:true)
        def scmVars = checkout scm
        
        // 2. COPY UTILITIES
        def command = "copy /Y \"${matlabSupportPkgRoot}\\toolbox\\padv\\pipeline_generator\\ci\\templates\\jenkins\\MW_PipelineUtils.groovy\" \"$WORKSPACE\""
        bat(command)
        
        // 3. GENERATE PIPELINE WITH FORCED PATH
        def pipelineUtils = load("$WORKSPACE/MW_PipelineUtils.groovy")
        
        // --- THE FIX IS HERE ---
        // We inject a command to RECURSIVELY add the Support Package folder to the path.
        // We also run 'ver' to print the toolboxes to the log so you can prove it loaded.
        def matlabCommand = "matlab -batch \"addpath(genpath('${matlabSupportPkgRoot}')); addpath('$WORKSPACE'); ver; generate_jenkins_pipeline();\""
        // -----------------------
        
        pipelineUtils.runShellCommand(matlabCommand, false)
        
        stash includes:"${pipelineGenerationPath}/**", name:'pipeline_generated_files'
        archiveArtifacts artifacts: "${pipelineGenerationPath}/**", allowEmptyArchive: true
        pipelineUtils.loadEnvVariables(false, scmVars.GIT_COMMIT)
    }
}

// 4. EXECUTE THE TESTS
load("${WORKSPACE}/${pipelineGenerationPath}/simulink_pipeline")