// Define path variable outside to ensure scope visibility
def pipelineGenerationPath = ""

node('simulink-test-jenkins-agent-label'){
    
    // 1. CONFIGURATION (HARDCODED FOR R2025a)
    // The Executable: We point directly to the R2025a exe (Bypass system PATH)
    def matlabExePath = "C:\\Program Files\\MATLAB\\R2025a\\bin\\matlab.exe"
    
    // The Support Package: We point to the R2025a support packages
    def matlabSupportPkgRoot = "C:\\ProgramData\\MATLAB\\SupportPackages\\R2025a"
    
    pipelineGenerationPath = "${env.MW_RELATIVE_PROJECT_PATH?:''}${env.MW_PIPELINE_GEN_DIRECTORY}"
    
    stage('Pipeline Generation'){
        cleanWs(disableDeferredWipeout:true, deleteDirs:true)
        def scmVars = checkout scm
        
        // 2. COPY UTILITIES
        def command = "copy /Y \"${matlabSupportPkgRoot}\\toolbox\\padv\\pipeline_generator\\ci\\templates\\jenkins\\MW_PipelineUtils.groovy\" \"$WORKSPACE\""
        bat(command)
        
        // 3. GENERATE PIPELINE
        def pipelineUtils = load("$WORKSPACE/MW_PipelineUtils.groovy")
        
        // 4. CONSTRUCT THE COMMAND
        // We use the full path to matlab.exe
        // We force the PATH to include support packages
        // We force the Cache/CodeGen folders to the WORKSPACE (Fixes the 'peter.zabos' permission error)
        def matlabCommand = """
            "${matlabExePath}" -batch "
            addpath(genpath('${matlabSupportPkgRoot}')); 
            addpath('$WORKSPACE'); 
            Simulink.fileGenControl('set', 'CacheFolder', '$WORKSPACE', 'CodeGenFolder', '$WORKSPACE', 'createDir', true);
            ver; 
            generate_jenkins_pipeline();"
        """
        
        // Clean up the command string for batch execution
        matlabCommand = matlabCommand.replaceAll("\n", "").replaceAll("  ", "")

        pipelineUtils.runShellCommand(matlabCommand, false)
        
        stash includes:"${pipelineGenerationPath}/**", name:'pipeline_generated_files'
        archiveArtifacts artifacts: "${pipelineGenerationPath}/**", allowEmptyArchive: true
        pipelineUtils.loadEnvVariables(false, scmVars.GIT_COMMIT)
    }

    stage('Simulink Pipeline'){
        // 5. EXECUTE THE TESTS
        load("${WORKSPACE}/${pipelineGenerationPath}/simulink_pipeline")
    }
}

